import{e as Q,u as z,r,j as e,f as G}from"./index-Dhmb56CU.js";import{a as H,d as J,p as K}from"./box-Chv2p0uG.js";import{B as u}from"./Button-Bmeh-JtX.js";import{M as V}from"./Modal-DJDRgEjf.js";const ae=()=>{const{boxId:n}=Q(),d=z(),[t,h]=r.useState(null),[R,I]=r.useState(null),[S,A]=r.useState(!0),[N,B]=r.useState(""),[C,P]=r.useState("user"),[q,m]=r.useState(!1),[l,k]=r.useState(null),[w,j]=r.useState(!1),[D,E]=r.useState([]),b=r.useRef(null),i=r.useRef(null),p=3e3;r.useEffect(()=>((async()=>{try{const[a,c]=await Promise.all([H(n),G()]);h(a),I(c.id),P(c.role)}catch(a){console.error("获取数据失败:",a),B("获取盲盒详情失败，请稍后重试")}finally{A(!1)}})(),()=>{i.current&&cancelAnimationFrame(i.current)}),[n]);const F=async()=>{if(n)try{await J(n),alert("盲盒已成功下架"),d("/home")}catch(s){console.error("下架盲盒失败:",s),alert("下架盲盒失败，请稍后重试")}},M=async()=>{m(!0)},U=async()=>{if(!(!n||!t)){m(!1);try{const s=await K(n);s.success&&(L(t.items,s.item),h(a=>a?{...a,boxNum:s.remaining}:null),setTimeout(()=>{k({item:s.item,remaining:s.remaining,message:s.message}),j(!1),h(a=>a?{...a,boxNum:s.remaining}:null),s.remaining===0&&setTimeout(()=>d("/home"),2e3)},p))}catch(s){if($(),s instanceof Error&&"response"in s){const{data:a}=s.response||{};a?.error==="余额不足"?(alert("购买失败: 余额不足，请充值"),d("/dashboard")):a?.error==="该盲盒已无可用物品"||a?.error==="Box not found"?(alert("购买失败: 盲盒已售罄"),d("/home")):alert(`购买失败: ${a?.error||"未知错误"}`)}else alert("购买失败: 网络错误")}}},L=(s,a)=>{j(!0);const c=[...s,...s,...s,...s,...s];E(c),requestAnimationFrame(()=>{const x=b.current;if(!x)return;x.scrollLeft=0;let f=null;const v=(c.findIndex(o=>o.name===a.name&&o.quantity===a.quantity)-2)*120,g=o=>{f||(f=o);const W=o-f,y=Math.min(W/p,1),O=T(y);x.scrollLeft=O*(v+1500),y<1?i.current=requestAnimationFrame(g):x.scrollLeft=v};i.current=requestAnimationFrame(g)})},T=s=>s*(2-s),$=()=>{i.current&&cancelAnimationFrame(i.current),j(!1)};return S?e.jsx("div",{className:"boxdetail-loading",children:"加载中..."}):N?e.jsx("div",{className:"boxdetail-error",children:N}):t?e.jsxs("div",{className:"boxdetail-container",children:[e.jsxs("div",{className:"boxdetail-header",children:[e.jsx("h1",{className:"boxdetail-title",children:t.boxName}),e.jsx("div",{className:"boxdetail-actions",children:R===t.userId||C==="admin"?e.jsx(u,{variant:"secondary",onClick:F,children:"下架盲盒"}):e.jsx(u,{variant:"primary",onClick:M,children:"购买盲盒"})})]}),e.jsxs("div",{className:"boxdetail-content",children:[e.jsx("div",{className:"boxdetail-image-section",children:t.boxAvatar?e.jsx("img",{src:t.boxAvatar,alt:t.boxName,className:"boxdetail-image"}):e.jsx("div",{className:"boxdetail-no-image",children:"暂无图片"})}),e.jsxs("div",{className:"boxdetail-info-section",children:[e.jsxs("div",{className:"boxdetail-meta",children:[e.jsxs("div",{className:"boxdetail-meta-item",children:[e.jsx("span",{className:"boxdetail-meta-label",children:"数量:"}),e.jsx("span",{className:"boxdetail-meta-value",children:t.boxNum})]}),e.jsxs("div",{className:"boxdetail-meta-item",children:[e.jsx("span",{className:"boxdetail-meta-label",children:"价格:"}),e.jsxs("span",{className:"boxdetail-meta-value",children:["¥",t.price]})]})]}),t.description&&e.jsxs("div",{className:"boxdetail-description",children:[e.jsx("h3",{children:"盲盒描述"}),e.jsx("p",{children:t.description})]}),e.jsxs("div",{className:"boxdetail-items",children:[e.jsx("h3",{children:"包含物品"}),e.jsx("ul",{className:"boxdetail-items-list",children:t.items.map((s,a)=>e.jsxs("li",{className:"boxdetail-item",children:[e.jsx("span",{className:"boxdetail-item-name",children:s.name}),e.jsxs("span",{className:"boxdetail-item-quantity",children:["x",s.quantity]})]},a))})]})]})]}),q&&e.jsx(V,{title:"确认购买",onClose:()=>m(!1),children:e.jsxs("div",{className:"purchase-modal-content",children:[e.jsx("p",{children:"确定要购买这个盲盒吗？"}),e.jsxs("p",{children:["价格: ¥",t.price]}),e.jsxs("div",{className:"purchase-modal-actions",children:[e.jsx(u,{onClick:()=>m(!1),variant:"secondary",children:"取消"}),e.jsx(u,{onClick:U,variant:"primary",children:"确认购买"})]})]})}),w&&e.jsx("div",{className:"rolling-overlay",children:e.jsxs("div",{className:"rolling-container",children:[e.jsx("h3",{className:"rolling-title",children:"开盒中..."}),e.jsx("div",{className:"items-container",ref:b,children:e.jsx("div",{className:"items-track",children:D.map((s,a)=>e.jsx("div",{className:"rolling-item",children:s.name},`${s.name}-${a}`))})}),e.jsx("div",{className:"center-indicator"})]})}),l&&e.jsxs("div",{className:"purchase-result",children:[e.jsx("h3",{children:l.message}),l.item&&e.jsxs("div",{className:"purchase-item",children:[e.jsxs("p",{children:["获得物品: ",l.item.name," *1"]}),e.jsxs("p",{children:["盲盒剩余数量: ",l.remaining]})]})]})]}):e.jsx("div",{className:"boxdetail-not-found",children:"盲盒不存在"})};export{ae as default};
