import{h as p,r as c,j as e,f as b}from"./index-Dhmb56CU.js";import{B as d}from"./Button-Bmeh-JtX.js";import{I as k}from"./Input-ChJNsZGx.js";import{T as D}from"./Textarea-BPyxjXkS.js";const L=async r=>(await p.post("/shows/create",r,{headers:{"Content-Type":"multipart/form-data"}})).data,E=async()=>(await p.get("/shows/all")).data,I=async r=>(await p.post("/shows/comment",r)).data,R=async r=>(await p.get(`/shows/${r}/comments`)).data,F=()=>{const[r,i]=c.useState([]),[f,u]=c.useState({}),[t,o]=c.useState({description:"",image:null,preview:""}),[l,g]=c.useState({}),[m,v]=c.useState(null),[j,N]=c.useState(!0),h=c.useRef(null),C=s=>{const a=s.target.files?.[0];if(a){if(!a.type.startsWith("image/")){alert("请上传图片文件");return}const n=URL.createObjectURL(a);o({...t,image:a,preview:n})}};c.useEffect(()=>()=>{t.preview&&URL.revokeObjectURL(t.preview)},[t.preview]),c.useEffect(()=>{(async()=>{try{const a=await b();v(a);const n=await E();i(n);const w={};for(const x of n){const U=await R(x.showId);w[x.showId]=U}u(w)}catch(a){console.error("Error fetching data:",a)}finally{N(!1)}})()},[]);const y=async()=>{if(!m||!t.description)return;const s=new FormData;s.append("description",t.description),t.image&&s.append("image",t.image);try{const a=await L(s);i([a,...r]),o({description:"",image:null,preview:""})}catch(a){console.error("Error creating show:",a)}},S=async s=>{if(!(!m||!l[s]))try{const a=await I({showId:s,content:l[s]});u(n=>({...n,[s]:[...n[s]||[],a]})),g(n=>({...n,[s]:""}))}catch(a){console.error("Error creating comment:",a)}};return j?e.jsx("div",{children:"Loading..."}):e.jsxs("div",{className:"show-page",children:[m&&e.jsxs("div",{className:"create-show",children:[e.jsx(D,{label:"分享你的想法",value:t.description,onChange:s=>o({...t,description:s.target.value})}),e.jsxs("div",{className:"image-upload",children:[e.jsx("input",{type:"file",ref:h,accept:"image/*",onChange:C,style:{display:"none"}}),e.jsx(d,{onClick:()=>h.current?.click(),children:"选择图片"}),t.preview&&e.jsxs("div",{className:"image-preview",children:[e.jsx("img",{src:t.preview,alt:"预览",onClick:()=>h.current?.click()}),e.jsx(d,{variant:"text",onClick:()=>o({...t,image:null,preview:""}),children:"删除"})]})]}),e.jsx(d,{onClick:y,className:"submitbutton",children:"发布"})]}),e.jsx("div",{className:"shows-list",children:r.map(s=>e.jsxs("div",{className:"show-item",children:[e.jsxs("div",{className:"show-header",children:[e.jsx("img",{src:s.userAvatar||"default-avatar.png",alt:s.username,className:"avatar"}),e.jsxs("div",{className:"user-info",children:[e.jsx("span",{className:"username",children:s.username}),e.jsx("span",{className:"time",children:new Date(s.createdAt).toLocaleString()})]})]}),e.jsxs("div",{className:"show-content",children:[e.jsx("p",{children:s.description}),s.imageUrl&&e.jsx("img",{src:s.imageUrl,alt:"分享图片",className:"show-image"})]}),e.jsxs("div",{className:"comments-section",children:[e.jsx("div",{className:"comments-list",children:f[s.showId]?.map(a=>e.jsxs("div",{className:"comment",children:[e.jsxs("div",{className:"comment-header",children:[e.jsx("img",{src:a.userAvatar||"default-avatar.png",alt:a.username,className:"avatar"}),e.jsxs("div",{className:"user-info",children:[e.jsx("span",{className:"username",children:a.username}),e.jsx("span",{className:"time",children:new Date(a.createdAt).toLocaleString()})]})]}),e.jsx("p",{className:"comment-content",children:a.content})]},a.commentId))}),m&&e.jsxs("div",{className:"add-comment",children:[e.jsx(k,{label:"评论",value:l[s.showId]||"",onChange:a=>g({...l,[s.showId]:a.target.value}),placeholder:"写下你的评论..."}),e.jsx(d,{onClick:()=>S(s.showId),className:"submitbutton",children:"评论"})]})]})]},s.showId))})]})};export{F as default};
