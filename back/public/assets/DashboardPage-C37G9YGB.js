import{u as $,r as n,j as e,f as q,g as z,b as G,c as H,s as J,d as K}from"./index-Dhmb56CU.js";import{B as t}from"./Button-Bmeh-JtX.js";import{I as i}from"./Input-ChJNsZGx.js";import{A as O}from"./Alert-DIwixrTu.js";import{M as p}from"./Modal-DJDRgEjf.js";import{T as Q}from"./Textarea-BPyxjXkS.js";const V=()=>{const d=$(),[o,x]=n.useState(null),[k,P]=n.useState(!0),[f]=n.useState(null),[I,j]=n.useState(0),[M,h]=n.useState(!1),[A,m]=n.useState(!1),[B,u]=n.useState(!1),[D,v]=n.useState(!1),[w,b]=n.useState(""),[y,N]=n.useState(""),[c,C]=n.useState({username:"",address:""}),[l,S]=n.useState({password:"",confirmPassword:""}),[g,s]=n.useState(null);n.useEffect(()=>{document.title="个人信息 - 盲盒平台";const a=async()=>{try{const r=await q();if(r){x({username:r.username,address:r.address,avatar:r.avatar||"https://via.placeholder.com/150",phone:r.phone,role:r.role,id:r.id});const L=await z();j(L.balance)}else localStorage.removeItem("token"),d("/login")}catch(r){console.error("获取用户信息出错:",r),localStorage.removeItem("token"),d("/login")}finally{P(!1)}};if(!localStorage.getItem("token")){d("/login");return}a()},[d]);const E=()=>{localStorage.removeItem("token"),d("/login")},R=async()=>{const a=parseFloat(w);if(isNaN(a)||a<=0){s({type:"error",message:"请输入有效的充值金额"});return}try{const r=await G(a);r.success&&(j(r.newBalance),h(!1),b(""),s({type:"success",message:`充值成功！当前余额: ${r.newBalance}`}))}catch(r){r instanceof Error?s({type:"error",message:r.message}):s({type:"error",message:"An unknown error occurred"})}},U=async()=>{try{const a=await H({username:c.username||void 0,address:c.address||void 0});a.success&&(x({...o,username:a.user.username,address:a.user.address}),s({type:"success",message:"个人信息更新成功"}),m(!1))}catch(a){a instanceof Error?s({type:"error",message:a.message}):s({type:"error",message:"An unknown error occurred"})}},T=async()=>{if(y.trim()==="114514")try{(await J(o.id)).success&&(s({type:"success",message:"您已成为管理员！"}),window.location.reload())}catch{s({type:"error",message:"设置管理员权限失败"})}else s({type:"error",message:"邀请码错误"}),N(""),setTimeout(()=>window.location.reload(),2e3);v(!1)},F=async()=>{try{if(l.password!==l.confirmPassword){s({type:"error",message:"两次输入的密码不一致"});return}const a=await K({newPassword:l.password,confirmPassword:l.confirmPassword});a.success&&(s({type:"success",message:a.message}),u(!1),setTimeout(()=>{s(null),localStorage.removeItem("token"),d("/login")},2e3))}catch(a){a instanceof Error?s({type:"error",message:a.message}):s({type:"error",message:"An unknown error occurred"})}};return k?e.jsx("div",{className:"dashboard-container",children:"加载中..."}):f?e.jsx("div",{className:"dashboard-container",children:f}):o?e.jsxs("div",{className:"dashboard-container",children:[g&&e.jsx(O,{type:g.type,message:g.message,onClose:()=>s(null),className:"dashboard-alert"}),e.jsx("div",{className:"dashboard-header",children:e.jsx("div",{className:"dashboard-avatar-container",children:o.avatar?e.jsx("img",{src:o.avatar,alt:"用户头像",className:"dashboard-avatar"}):e.jsx("span",{children:"暂无图片"})})}),e.jsxs("div",{className:"dashboard-info",children:[e.jsxs("h2",{className:"dashboard-username",children:["用户名：",o.username]}),o.address&&e.jsxs("p",{className:"dashboard-address",children:["地址：",o.address]}),e.jsxs("p",{className:"dashboard-phone",children:["手机号：",o.phone]}),e.jsxs("p",{className:"dashboard-balance",children:["账户余额：¥",I]}),e.jsxs("p",{className:"dashboard-balance",children:["用户角色：",o.role==="admin"?"管理员":"普通用户"]}),e.jsx("div",{className:"dashboard-button-row",children:e.jsx(t,{onClick:()=>h(!0),variant:"primary",children:"充值"})})]}),o.role==="user"&&e.jsx("div",{className:"dashboard-button-row",children:e.jsx(t,{onClick:()=>v(!0),variant:"secondary",children:"输入管理员邀请码"})}),e.jsxs("div",{className:"dashboard-buttons",children:[e.jsxs("div",{className:"dashboard-button-row",children:[e.jsx(t,{onClick:()=>m(!0),variant:"secondary",children:"修改个人信息"}),e.jsx(t,{onClick:()=>u(!0),variant:"secondary",children:"修改密码"}),o.role==="admin"&&e.jsx("div",{className:"dashboard-button-row",children:e.jsx(t,{onClick:()=>d("/adminorder"),variant:"danger",children:"管理员订单管理系统"})})]}),e.jsx("div",{className:"dashboard-button-row",children:e.jsx(t,{onClick:E,variant:"text",children:"退出登录"})})]}),M&&e.jsx(p,{title:"账户充值",onClose:()=>h(!1),children:e.jsxs("div",{className:"dashboard-modal-content",children:[e.jsx(i,{label:"充值金额",type:"number",min:"0.01",step:"0.01",value:w,onChange:a=>b(a.target.value),placeholder:"请输入充值金额"}),e.jsxs("div",{className:"dashboard-modal-actions",children:[e.jsx(t,{onClick:()=>h(!1),variant:"secondary",children:"取消"}),e.jsx(t,{onClick:R,variant:"primary",children:"确认充值"})]})]})}),A&&e.jsx(p,{title:"修改个人信息",onClose:()=>m(!1),children:e.jsxs("div",{className:"dashboard-modal-content",children:[e.jsx(i,{label:"用户名",value:c.username||o.username,onChange:a=>C({...c,username:a.target.value})}),e.jsx(Q,{label:"地址",value:c.address||o.address||"",onChange:a=>C({...c,address:a.target.value}),rows:3}),e.jsxs("div",{className:"dashboard-modal-actions",children:[e.jsx(t,{onClick:()=>m(!1),variant:"secondary",children:"取消"}),e.jsx(t,{onClick:U,variant:"primary",children:"保存"})]})]})}),D&&e.jsx(p,{title:"输入管理员邀请码",onClose:()=>v(!1),children:e.jsxs("div",{className:"dashboard-modal-content",children:[e.jsx(i,{label:"邀请码",type:"password",value:y,onChange:a=>N(a.target.value),placeholder:"请输入管理员邀请码"}),e.jsxs("div",{className:"dashboard-modal-actions",children:[e.jsx(t,{onClick:()=>v(!1),variant:"secondary",children:"取消"}),e.jsx(t,{onClick:T,variant:"primary",children:"确认"})]})]})}),B&&e.jsx(p,{title:"修改密码",onClose:()=>u(!1),children:e.jsxs("div",{className:"dashboard-modal-content",children:[e.jsx(i,{label:"新密码",type:"password",value:l.password,onChange:a=>S({...l,password:a.target.value})}),e.jsx(i,{label:"确认密码",type:"password",value:l.confirmPassword,onChange:a=>S({...l,confirmPassword:a.target.value})}),e.jsxs("div",{className:"dashboard-modal-actions",children:[e.jsx(t,{onClick:()=>u(!1),variant:"secondary",children:"取消"}),e.jsx(t,{onClick:F,variant:"primary",children:"确认修改"})]})]})})]}):e.jsx("div",{className:"dashboard-container",children:"未找到用户数据"})},ae=()=>e.jsx("div",{className:"dashboard-page",children:e.jsx(V,{})});export{ae as default};
